<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Potta+One&display=swap" rel="stylesheet">
<title>點名</title>
<style>
    body { margin:2px; background-color:#1B263B; color:#E0E1DD; }
    body button{ font-family:"Potta One", system-ui, sans-serif; }
    h2{ margin-top:20px; font-family:"Potta One", system-ui, sans-serif; }
    .toolbar{ display:grid; grid-template-columns:repeat(6,1fr); gap:10px; margin-bottom:15px; }
    button{ padding:12px; font-size:16px; border:none; border-radius:5px; background-color:#7798AB; color:black; cursor:pointer; }
    .grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:8px; }
    .person{ position:relative; padding:10px; text-align:center; border:1px solid #ccc; border-radius:5px; background:#1B263B; cursor:pointer; user-select:none; font-family:"Potta One", system-ui, sans-serif; }
    .person.active{ background:#C3DBC5; color:black }
    .dot{ position:absolute; top:5px; right:5px; width:10px; height:10px; background:red; border-radius:50%; }
    .modal-bg{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
    .modal{ background:#fff; color:black; padding:20px; border-radius:10px; max-height:90%; overflow:auto; }
    table{ border-collapse:collapse; width:100%; margin-top:10px; }
    th, td{ border:1px solid #ccc; padding:5px; text-align:center; }
    th{ background:#eee; position:sticky; top:0; }
    tr:nth-child(even){ background:#f9f9f9; }
    .guestCountBtn{
      width: 50px;
    }
    span#guestCount{
      display: inline-block;
      width: 100px;
      text-align: center;
      font-size: x-large;
    }
</style>
</head>
<body>

<div class="toolbar">
  <button onclick="showAddModal()">新增</button>
  <button onclick="clearSelection()">清除選取</button>
  <button onclick="clearAll()" style="background-color: darkred; color: rgb(211, 200, 200);">刪除全部</button>
  <button onclick="clearHistory()">整理出席</button>
  <button onclick="showExportModal()">輸出</button>
  <button onclick="showHistoryModal()">歷史</button>
</div>

<h2>成員</h2>
<div id="members" class="grid"></div>

<h2>訪客</h2>
<div id="guestControls">
  <button class="guestCountBtn" onclick="changeGuestCount(-1)">-</button>
  <span id="guestCount">0</span>
  <button class="guestCountBtn" onclick="changeGuestCount(1)">+</button>
</div>
<div id="guests" class="grid"></div>

<!-- 新增 Modal -->
<div id="addModalBg" class="modal-bg">
  <div class="modal">
    <h3>新增人員</h3>
    <textarea id="addNames" rows="6" style="width:100%;"></textarea><br>
    <label><input type="radio" name="defaultActive" value="today" checked> 預設為積極 (加入今天的出席紀錄)</label><br>
    <label><input type="radio" name="defaultActive" value="yesterday"> 預設為積極 (加入昨天的出席紀錄)</label><br>
    <label><input type="radio" name="defaultActive" value="none"> 不自動加入出席紀錄</label><br><br>
    <button onclick="addPeople()">新增</button>
    <button onclick="closeModal('addModalBg')">關閉</button>
  </div>
</div>

<!-- 編輯 Modal -->
<div id="editModalBg" class="modal-bg">
  <div class="modal">
    <h3>編輯人員</h3>
    <input id="editName" placeholder="名字" style="width:100%;"><br><br>
    <div><strong>出席紀錄:</strong>
      <ul id="editDates" style="max-height:100px; overflow:auto; padding-left:20px;"></ul>
    </div><br>
    <button onclick="saveEdit()">儲存</button>
    <button onclick="deleteSelected()">刪除</button>
    <button onclick="closeModal('editModalBg')">關閉</button>
  </div>
</div>

<!-- 輸出 Modal -->
<div id="exportModalBg" class="modal-bg">
  <div class="modal">
    <h3>輸出</h3>
    <label>日期: <input type="date" id="exportDate"></label><br><br>
    <button onclick="doExport('all')">全部</button>
    <button onclick="doExport('attend')">出席</button>
    <button onclick="doExport('absent')">缺席</button>
    <button onclick="confirmAttendance()">確認點名</button>
    <div id="exportResult" style="margin-top:10px; white-space:pre-wrap;"></div>
    <button onclick="closeModal('exportModalBg')">關閉</button>
  </div>
</div>

<!-- 歷史 Modal -->
<div id="historyModalBg" class="modal-bg">
  <div class="modal" style="width:90%; max-width:800px;">
    <h3>歷史紀錄</h3>
    <label>開始: <input type="date" id="historyStart"></label>
    <label>結束: <input type="date" id="historyEnd"></label>
    <button onclick="generateHistory()">產生</button>
    <button onclick="exportHistoryJson()">匯出 JSON</button>
    <div id="historyTable"></div>
    <button onclick="closeModal('historyModalBg')">關閉</button>
  </div>
</div>

<script>
let people = [];
let idCounter = 1;
let guestCount = 0;
let selectedId = null;

function saveData(){
  localStorage.setItem("peopleData", JSON.stringify({people,idCounter,guestCount}));
}
function loadData(){
  let data = localStorage.getItem("peopleData");
  if(data){
    let parsed = JSON.parse(data);
    people = parsed.people || [];
    idCounter = parsed.idCounter || 1;
    guestCount = parsed.guestCount || 0;
    document.getElementById("guestCount").innerText = guestCount;
  }
}

function render(){
  let members = people.sort((a,b)=>b.count-a.count || a.id-b.id);
  document.getElementById("members").innerHTML = members.map(p=>renderPerson(p)).join("");
  
  saveData();
}

function renderPerson(p){
  return `<div class="person ${p.active?'active':''}" 
              onclick="toggleActive(${p.id})"
              ondblclick="selectForEdit(${p.id})">
            ${p.name}
            ${isActive(p) ? '<div class="dot"></div>' : ''}
          </div>`;
}

function isActive(person) {
  if (!person.dates || person.dates.length === 0) return false;

  let today = new Date();

  // 上個月的範圍
  let lastMonthFirst = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  let lastMonthLast = new Date(today.getFullYear(), today.getMonth(), 0);

  // 這個月的範圍
  let thisMonthFirst = new Date(today.getFullYear(), today.getMonth(), 1);
  let thisMonthLast = today; // 只檢查到今天

  let hasLastMonth = person.dates.some(d => {
    let date = new Date(d);
    return date >= lastMonthFirst && date <= lastMonthLast;
  });

  let hasThisMonth = person.dates.some(d => {
    let date = new Date(d);
    return date >= thisMonthFirst && date <= thisMonthLast;
  });

  return hasLastMonth || hasThisMonth;
}

function toggleActive(id){
  let person = people.find(p=>p.id===id);
  person.active = !person.active;
  render();
}

function selectForEdit(id){
  selectedId=id;
  let p=people.find(x=>x.id===id);
  document.getElementById("editName").value=p.name;
  let ul=document.getElementById("editDates");
  ul.innerHTML=(p.dates||[]).map(d=>`<li>${d}</li>`).join("");
  document.getElementById("editModalBg").style.display="flex";
}

function showAddModal(){ document.getElementById("addModalBg").style.display="flex"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }

function addPeople(){
  let names = document.getElementById("addNames").value.trim().split("\n");
  let todayStr = getToday();
  let radios = document.querySelectorAll("input[name='defaultActive']");
  let selected = [...radios].find(r=>r.checked)?.value;
  names.forEach(name=>{
    if(name){
      people.push({
        id:idCounter++,
        name:name.trim(),
        count:1,
        type:"成員",
        active:false,
        dates: (selected==="today")?[todayStr]:(selected==="yesterday")?[getYesterday()]:[]
      });
    }
  });
  document.getElementById("addNames").value="";
  closeModal("addModalBg");
  render();
}

function saveEdit(){
  if(selectedId){
    let p=people.find(x=>x.id===selectedId);
    p.name=document.getElementById("editName").value.trim();
    closeModal("editModalBg");
    render();
  }
}
function deleteSelected(){
  if(selectedId){
    people=people.filter(p=>p.id!==selectedId);
    selectedId=null;
    closeModal("editModalBg");
    render();
  }else alert("請先雙擊一個人再刪除");
}

function clearSelection(){ people.forEach(p=>p.active=false); render(); }
function clearAll(){ if(confirm("確定要刪除所有人嗎？")){ people=[]; saveData(); render(); } }

function changeGuest(id,delta){
  let g=people.find(x=>x.id===id);
  g.count=Math.max(1,(g.count||1)+delta);
  render();
}

function changeGuestCount(delta){
  guestCount+=delta;
  if(guestCount<0) guestCount=0;
  document.getElementById("guestCount").innerText=guestCount;
  saveData();
}

// 輸出
function showExportModal(){
  document.getElementById("exportDate").value=getToday();
  document.getElementById("exportResult").innerText="";
  document.getElementById("exportModalBg").style.display="flex";
}

function doExport(type){
  let date = document.getElementById("exportDate").value;
  if(!date) { alert("請選擇日期"); return; }

  // 根據選擇日期判斷出席 / 缺席
  let attendees = people.filter(p => p.dates && p.dates.includes(date)).map(p => p.name);
  let absentees = people.filter(p => !p.dates || !p.dates.includes(date)).map(p => p.name);

  let txt = "";
  if(type === "all") 
    txt = `${date}\n訪客數:${guestCount}\n\n出席:\n${attendees.join("\n")}\n\n缺席:\n${absentees.join("\n")}`;
  else if(type === "attend") 
    txt = `${date}\n訪客數:${guestCount}\n\n出席:\n${attendees.join("\n")}`;
  else if(type === "absent") 
    txt = `${date}\n訪客數:${guestCount}\n\n缺席:\n${absentees.join("\n")}`;

  document.getElementById("exportResult").innerText = txt;
  navigator.clipboard.writeText(txt);
}


function confirmAttendance(){
  let date=document.getElementById("exportDate").value;
  if(!date){ alert("請先選擇日期"); return; }
  people.forEach(p=>{
    if(p.active){
      if(!p.dates) p.dates=[];
      if(!p.dates.includes(date)) p.dates.push(date);
    }
  });
  saveData();
  doExport("absent");
}

// 歷史
function showHistoryModal(){
  let today=getToday();
  let monthAgo=new Date(); monthAgo.setMonth(monthAgo.getMonth()-1);
  document.getElementById("historyStart").value=monthAgo.toISOString().split("T")[0];
  document.getElementById("historyEnd").value=today;
  document.getElementById("historyTable").innerHTML="";
  document.getElementById("historyModalBg").style.display="flex";
}

function generateHistory(){
  let start=document.getElementById("historyStart").value;
  let end=document.getElementById("historyEnd").value;
  if(!start||!end){ alert("請先選擇日期範圍"); return; }
  let startDate=new Date(start), endDate=new Date(end);
  let dateSet=new Set();
  people.forEach(p=>{ if(p.dates) p.dates.forEach(d=>{ let dt=new Date(d); if(dt>=startDate && dt<=endDate) dateSet.add(d); }); });
  let dateList=Array.from(dateSet).sort((a,b)=>new Date(a)-new Date(b));
  if(dateList.length===0){ document.getElementById("historyTable").innerHTML="這段期間沒有出席紀錄"; return; }
  let html=`<table><thead><tr><th>名字</th>${dateList.map(d=>`<th>${d}</th>`).join("")}</tr></thead><tbody>`;
  people.forEach((p,i)=>{
    if(!p.dates || p.dates.length===0) return;
    html+=`<tr style="background:${i%2?"#f9f9f9":"#fff"};"><td>${p.name}</td>${dateList.map(d=>`<td>${p.dates.includes(d)?"✔️":""}</td>`).join("")}</tr>`;
  });
  html+="</tbody></table>";
  document.getElementById("historyTable").innerHTML=html;
}

function exportHistoryJson(){
  let start = document.getElementById("historyStart").value;
  let end = document.getElementById("historyEnd").value;

  // 將成員整理
  let membersData = people
    .filter(p => p.type === "成員")
    .map(p => ({
      name: p.name,
      dates: p.dates || []
    }));

  let data = {
    start,
    end,
    people: membersData
  };

  navigator.clipboard.writeText(JSON.stringify(data, null, 2));
  alert("已複製 JSON");
}

function clearHistory(){
  if(confirm("僅保留最近三個月的出席紀錄，確定嗎？")){
    let cutoff = new Date();
    cutoff.setMonth(cutoff.getMonth()-3);
    people.forEach(p=>{
      if(p.dates){
        p.dates = p.dates.filter(d=>{
          return new Date(d) >= cutoff;
        });
      }
    });
    render();
  }
}

// 日期工具
function getToday(){ return new Date().toISOString().split("T")[0]; }
function getYesterday(){ let t=new Date(); t.setDate(t.getDate()-1); return t.toISOString().split("T")[0]; }

// 初始化
loadData();
render();
</script>

</body>
</html>
